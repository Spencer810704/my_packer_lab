# å‹•æ…‹ç©æœ¨å¼ AMI å»ºæ§‹ç³»çµ±

é€™å€‹å°ˆæ¡ˆä½¿ç”¨ Packer å¯¦ç¾å‹•æ…‹ç©æœ¨å¼ AMI å»ºæ§‹ï¼Œæ”¯æ´å½ˆæ€§çµ„åˆä¸åŒçš„ç³»çµ±çµ„ä»¶ã€æ‡‰ç”¨ç¨‹å¼å’Œé…ç½®ã€‚é€šé Jenkins Pipeline æä¾›æ¨™æº–åŒ–çš„å»ºæ§‹æµç¨‹ã€‚

## ğŸš€ æ ¸å¿ƒç‰¹è‰²

- **ğŸ§© å‹•æ…‹ç©æœ¨çµ„åˆ**ï¼šæ¨¡çµ„åŒ–è¨­è¨ˆï¼Œå¯å½ˆæ€§çµ„åˆä¸åŒç©æœ¨
- **ğŸ”„ å¤šä½œæ¥­ç³»çµ±æ”¯æ´**ï¼šUbuntuã€Amazon Linuxã€RHEL ç³»åˆ—
- **âš™ï¸ æ™ºèƒ½æ¢ä»¶åŸ·è¡Œ**ï¼šåªåŸ·è¡Œé¸æ“‡çš„ç©æœ¨ç›¸é—œè…³æœ¬
- **ğŸ·ï¸ è‡ªå‹•æ¨™ç±¤åˆ†é¡**ï¼šæ™ºèƒ½åˆ†é¡ä¸¦æ¨™è¨˜ä¸åŒé¡å‹çš„ç©æœ¨
- **ğŸ” å®‰å…¨æ€§å…§å»º**ï¼šé˜²ç«ç‰†ã€fail2banã€ç³»çµ±åŠ å›º
- **ğŸ“Š Jenkins æ•´åˆ**ï¼šæ¨™æº–åŒ–å»ºæ§‹æµç¨‹å’Œçµæœè¿½è¹¤

## ğŸ“ å°ˆæ¡ˆçµæ§‹

```
packer/
â”œâ”€â”€ README.md                     # å°ˆæ¡ˆèªªæ˜æ–‡ä»¶
â”œâ”€â”€ Jenkinsfile                   # Jenkins Pipeline é…ç½®
â”œâ”€â”€ engine/                       # å‹•æ…‹å»ºæ§‹å¼•æ“
â”‚   â””â”€â”€ builder.pkr.hcl           # ä¸»è¦ Packer é…ç½®æª”æ¡ˆ
â””â”€â”€ blocks/                       # ç©æœ¨åº«
    â”œâ”€â”€ base/                     # åŸºç¤ç³»çµ±ç©æœ¨
    â”‚   â”œâ”€â”€ ubuntu-2004/          # Ubuntu 20.04 åŸºç¤ç©æœ¨
    â”‚   â”œâ”€â”€ amazon-linux-2/       # Amazon Linux 2 åŸºç¤ç©æœ¨
    â”‚   â””â”€â”€ rhel-8/               # RHEL 8 åŸºç¤ç©æœ¨
    â”œâ”€â”€ applications/             # æ‡‰ç”¨ç¨‹å¼ç©æœ¨
    â”‚   â”œâ”€â”€ docker/               # Docker å®¹å™¨å¼•æ“
    â”‚   â”‚   â”œâ”€â”€ block.yaml        # ç©æœ¨é…ç½®æª”æ¡ˆ
    â”‚   â”‚   â””â”€â”€ scripts/          # å¤šä½œæ¥­ç³»çµ±è…³æœ¬
    â”‚   â”‚       â”œâ”€â”€ debian/       # Debian/Ubuntu å°ˆç”¨
    â”‚   â”‚       â”œâ”€â”€ rhel/         # RHEL ç³»åˆ—å°ˆç”¨
    â”‚   â”‚       â”œâ”€â”€ amazon-linux/ # Amazon Linux å°ˆç”¨
    â”‚   â”‚       â””â”€â”€ common/       # å…±ç”¨è…³æœ¬
    â”‚   â””â”€â”€ openresty/            # OpenResty Web Server
    â”‚       â”œâ”€â”€ block.yaml
    â”‚       â””â”€â”€ scripts/
    â””â”€â”€ configurations/           # é…ç½®ç©æœ¨
        â”œâ”€â”€ security/             # å®‰å…¨é…ç½®
        â”œâ”€â”€ monitoring/           # ç›£æ§é…ç½®
        â””â”€â”€ logging/              # æ—¥èªŒé…ç½®
```

## ğŸ§© ç©æœ¨ç³»çµ±èªªæ˜

### ç©æœ¨åˆ†å±¤æ¶æ§‹

æœ¬ç³»çµ±æ¡ç”¨æ¸…æ™°çš„åˆ†å±¤æ¶æ§‹ï¼Œç¢ºä¿ä¸åŒé¡å‹çš„è»Ÿé«”å’Œé…ç½®èƒ½å¤ æ­£ç¢ºæ­¸é¡ï¼Œæé«˜ç¶­è­·æ€§å’Œé‡ç”¨æ€§ã€‚

#### ğŸ—ï¸ å››å±¤æ¶æ§‹è¨­è¨ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         ç¬¬4å±¤: é…ç½®ç®¡ç† (Ansible/cloud-init)         â”‚
â”‚  - ç’°å¢ƒå·®ç•°åŒ–é…ç½®                                    â”‚
â”‚  - å‹•æ…‹åƒæ•¸æ³¨å…¥                                      â”‚
â”‚  - å¯¦ä¾‹ç‰¹å®šè¨­å®š                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚         ç¬¬3å±¤: è‡ªå®šç¾©ç©æœ¨ (Custom Blocks)            â”‚
â”‚  - å•†æ¥­æˆæ¬Šè»Ÿé«”                                      â”‚
â”‚  - å®¢æˆ¶å°ˆæœ‰æ‡‰ç”¨                                      â”‚
â”‚  - è¡Œæ¥­ç‰¹å®šç³»çµ±                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚         ç¬¬2å±¤: é€šç”¨æœå‹™ç©æœ¨ (Application Blocks)     â”‚
â”‚  - é–‹æºä¸­ä»‹è»Ÿé«”                                      â”‚
â”‚  - é€šç”¨è³‡æ–™åº«                                        â”‚
â”‚  - é–‹ç™¼æ¡†æ¶å’Œé‹è¡Œç’°å¢ƒ                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚         ç¬¬1å±¤: åŸºç¤ç³»çµ±ç©æœ¨ (Base Blocks)            â”‚
â”‚  - ä½œæ¥­ç³»çµ±æ ¸å¿ƒ                                      â”‚
â”‚  - ç³»çµ±å·¥å…·å’Œæ›´æ–°                                    â”‚
â”‚  - åŸºç¤å®‰å…¨è¨­å®š                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### ğŸ“Š åˆ†å±¤åˆ¤æ–·æ¨™æº–

| åˆ¤æ–·æ¢ä»¶ | é€šç”¨æœå‹™ç©æœ¨ (ç¬¬2å±¤) | è‡ªå®šç¾©ç©æœ¨ (ç¬¬3å±¤) |
|---------|---------------------|-------------------|
| **æˆæ¬Šé¡å‹** | é–‹æº/å…è²»è»Ÿé«” | å•†æ¥­æˆæ¬Š/å°ˆæœ‰è»Ÿé«” |
| **é€šç”¨ç¨‹åº¦** | è·¨è¡Œæ¥­é€šç”¨ | ç‰¹å®šå®¢æˆ¶/è¡Œæ¥­ |
| **é…ç½®è¤‡é›œåº¦** | æ¨™æº–åŒ–é…ç½® | é«˜åº¦å®¢è£½åŒ– |
| **ä¿å¯†ç­‰ç´š** | å…¬é–‹è³‡è¨Š | å¯èƒ½åŒ…å«å•†æ¥­æ©Ÿå¯† |
| **æ›´æ–°ç®¡ç†** | ç¤¾ç¾¤ç¶­è­· | å®¢æˆ¶è‡ªè¡Œæ§åˆ¶ |

#### ğŸ’¡ å…·é«”åˆ†é¡ç¯„ä¾‹

**âœ… æ‡‰æ”¾åœ¨é€šç”¨æœå‹™å±¤ï¼ˆç¬¬2å±¤ï¼‰çš„ç©æœ¨ï¼š**
```yaml
# é–‹æºä¸”é€šç”¨çš„æœå‹™
app-nginx          # é–‹æº Web ä¼ºæœå™¨
app-postgresql     # é–‹æºé—œè¯å¼è³‡æ–™åº«
app-redis          # é–‹æºè¨˜æ†¶é«”å¿«å–
app-elasticsearch  # é–‹æºæœå°‹å¼•æ“
app-docker         # é–‹æºå®¹å™¨å¹³å°
app-jenkins        # é–‹æº CI/CD å·¥å…·
app-prometheus     # é–‹æºç›£æ§ç³»çµ±
```

**âœ… æ‡‰æ”¾åœ¨è‡ªå®šç¾©å±¤ï¼ˆç¬¬3å±¤ï¼‰çš„ç©æœ¨ï¼š**
```yaml
# éœ€è¦ç‰¹æ®Šæˆæ¬Šæˆ–é«˜åº¦å®¢è£½åŒ–
custom-oracle-db           # å•†æ¥­è³‡æ–™åº«ï¼Œéœ€æˆæ¬Š
custom-sap-erp            # ä¼æ¥­ç´š ERP ç³»çµ±
custom-clientA-backend    # å®¢æˆ¶ A çš„å°ˆæœ‰å¾Œç«¯æœå‹™
custom-trading-platform   # é‡‘èäº¤æ˜“ç³»çµ±
custom-hospital-his       # é†«é™¢è³‡è¨Šç³»çµ±
custom-dynatrace-agent    # å•†æ¥­ç›£æ§å·¥å…·
```

### ç©æœ¨é¡å‹

#### 1. åŸºç¤ç³»çµ±ç©æœ¨ (Base Blocks)
æä¾›ä½œæ¥­ç³»çµ±åŸºç¤ç’°å¢ƒï¼Œæ¯æ¬¡å»ºæ§‹å¿…é ˆé¸æ“‡ä¸€å€‹åŸºç¤ç©æœ¨ã€‚

**å¯ç”¨ç©æœ¨ï¼š**
- `base-ubuntu-2004`: Ubuntu 20.04 LTS åŸºç¤ç³»çµ±
- `base-ubuntu-2204`: Ubuntu 22.04 LTS åŸºç¤ç³»çµ±  
- `base-amazon-linux-2`: Amazon Linux 2 åŸºç¤ç³»çµ±
- `base-rhel-8`: Red Hat Enterprise Linux 8 åŸºç¤ç³»çµ±

**åŒ…å«åŠŸèƒ½ï¼š**
- ç³»çµ±æ›´æ–°å’ŒåŸºæœ¬å¥—ä»¶å®‰è£
- ç³»çµ±å„ªåŒ–é…ç½®
- åŸºç¤å®‰å…¨è¨­å®š

#### 2. æ‡‰ç”¨ç¨‹å¼ç©æœ¨ (Application Blocks)  
æä¾›ç‰¹å®šæ‡‰ç”¨ç¨‹å¼å’Œæœå‹™ï¼Œå¯é¸æ“‡å¤šå€‹æ‡‰ç”¨ç©æœ¨ã€‚

**å¯ç”¨ç©æœ¨ï¼š**
- `app-docker`: Docker å®¹å™¨å¼•æ“ + Docker Compose
- `app-openresty`: OpenResty Web Server (Nginx + Lua)
- `app-nginx`: æ¨™æº– Nginx Web Server
- `app-nodejs`: Node.js é‹è¡Œç’°å¢ƒ

**åŠŸèƒ½ç‰¹è‰²ï¼š**
- å¤šä½œæ¥­ç³»çµ±æ”¯æ´è…³æœ¬
- è‡ªå‹•æœå‹™å•Ÿå‹•é…ç½®
- ç‰ˆæœ¬é©—è­‰å’Œå¥åº·æª¢æŸ¥

#### 3. é…ç½®ç©æœ¨ (Configuration Blocks)
æä¾›ç³»çµ±é…ç½®å’Œå®‰å…¨åŠ å›ºï¼Œå¯é¸æ“‡å¤šå€‹é…ç½®ç©æœ¨ã€‚

**å¯ç”¨ç©æœ¨ï¼š**
- `config-security`: é˜²ç«ç‰† + fail2ban + ç³»çµ±åŠ å›º
- `config-monitoring`: ç³»çµ±ç›£æ§å’Œæ—¥èªŒæ”¶é›†
- `config-logging`: ä¸­å¤®åŒ–æ—¥èªŒé…ç½®
- `config-backup`: è‡ªå‹•å‚™ä»½é…ç½®

**å®‰å…¨åŠŸèƒ½ï¼š**
- UFW é˜²ç«ç‰†é…ç½®
- fail2ban å…¥ä¾µé˜²è­·
- SSH å®‰å…¨åŠ å›º
- ç³»çµ±æ¬Šé™å„ªåŒ–

## ğŸ·ï¸ æ™ºèƒ½æ¨™ç±¤ç³»çµ±

AMI å»ºæ§‹å®Œæˆå¾Œï¼Œç³»çµ±æœƒè‡ªå‹•æ ¹æ“šé¸æ“‡çš„ç©æœ¨é¡å‹å»ºç«‹åˆ†é¡æ¨™ç±¤ï¼š

### æ¨™ç±¤çµæ§‹
```yaml
# åŸºæœ¬æ¨™ç±¤
JenkinsBuild: "å»ºæ§‹ç·¨è™Ÿ"
Requester: "è«‹æ±‚è€…"
BuildDate: "å»ºæ§‹æ—¥æœŸ"

# ç©æœ¨åˆ†é¡æ¨™ç±¤ï¼ˆæ ¹æ“šé¸æ“‡çš„ç©æœ¨å‹•æ…‹ç”Ÿæˆï¼‰
Base: "ubuntu-2004"                    # åŸºç¤ç³»çµ±ï¼ˆå–®ä¸€å€¼ï¼‰
Applications: "docker_openresty"        # æ‡‰ç”¨ç¨‹å¼ï¼ˆå¤šå€¼ç”¨åº•ç·šåˆ†éš”ï¼‰
Configurations: "security_monitoring"   # é…ç½®ï¼ˆå¤šå€¼ç”¨åº•ç·šåˆ†éš”ï¼‰  
Custom: "special_tool"                  # è‡ªå®šç¾©ç©æœ¨
```

### æ¨™ç±¤ç¯„ä¾‹
**é¸æ“‡ç©æœ¨ï¼š** `["base-ubuntu-2004", "app-docker", "app-nginx", "config-security", "config-monitoring"]`

**ç”¢ç”Ÿæ¨™ç±¤ï¼š**
- `Base: ubuntu-2004`
- `Applications: docker_nginx`
- `Configurations: security_monitoring`

## ğŸ“‹ ä½¿ç”¨æ–¹å¼

### Jenkins Pipeline åŸ·è¡Œ

#### 1. å»ºç«‹ Pipeline Job
- åœ¨ Jenkins ä¸­å»ºç«‹æ–°çš„ Pipeline å°ˆæ¡ˆ
- æŒ‡å‘æ­¤å°ˆæ¡ˆçš„ `Jenkinsfile`

#### 2. é…ç½®å»ºæ§‹åƒæ•¸

| åƒæ•¸ | èªªæ˜ | ç¯„ä¾‹å€¼ |
|------|------|--------|
| `ENABLED_BLOCKS` | é¸æ“‡çš„ç©æœ¨åˆ—è¡¨ (JSONæ ¼å¼) | `["base-ubuntu-2004","app-docker","config-security"]` |
| `ENVIRONMENT` | ç›®æ¨™ç’°å¢ƒ | `dev`, `stg`, `prod` |
| `AWS_REGION` | AWS å€åŸŸ | `ap-northeast-1` |
| `INSTANCE_TYPE` | EC2 å¯¦ä¾‹é¡å‹ | `t3.micro`, `t3.small` |
| `BASE_AMI_ID` | åŸºåº• AMI ID (å¿…å¡«) | `ami-0836e97b3d843dd82` |
| `BUILD_NAME` | è‡ªè¨‚å»ºæ§‹åç¨± | `webserver`, `database` |
| `OWNER` | è³‡æºæ“æœ‰è€… | `infra-team` |
| `DRY_RUN` | åƒ…é©—è­‰ä¸å»ºæ§‹ | `false` |

#### 3. å¸¸ç”¨ç©æœ¨çµ„åˆç¯„ä¾‹

**åŸºç¤ Web Serverï¼š**
```json
["base-ubuntu-2004", "app-nginx", "config-security"]
```

**Docker é–‹ç™¼ç’°å¢ƒï¼š**
```json
["base-ubuntu-2004", "app-docker", "config-security", "config-monitoring"]
```

**OpenResty Web Serverï¼š**
```json
["base-ubuntu-2004", "app-openresty", "config-security"]
```

**å¤šç”¨é€”æ‡‰ç”¨ä¼ºæœå™¨ï¼š**
```json
["base-ubuntu-2004", "app-docker", "app-nginx", "config-security", "config-monitoring", "config-logging"]
```

## ğŸ”§ Jenkins Pipeline æµç¨‹

```mermaid
graph TD
    A[ğŸ“‹ é©—è­‰åƒæ•¸] --> B[ğŸ”§ æº–å‚™å»ºæ§‹ç’°å¢ƒ]
    B --> C[âœ… Packer é©—è­‰]
    C --> D{ğŸ”„ DRY_RUN?}
    D -->|Yes| E[âœ‹ é©—è­‰å®Œæˆ]
    D -->|No| F[ğŸš€ å»ºæ§‹ AMI]
    F --> G[ğŸ“Š è™•ç†å»ºæ§‹çµæœ]
    G --> H[ğŸ·ï¸ æ–°å¢ AMI æ¨™ç±¤]
    H --> I[âœ… å»ºæ§‹å®Œæˆ]
```

## ğŸ› ï¸ ç©æœ¨é–‹ç™¼æŒ‡å—

### æ–°å¢ç©æœ¨çš„æ­¥é©Ÿ

1. **å»ºç«‹ç©æœ¨ç›®éŒ„çµæ§‹**
   ```bash
   mkdir -p blocks/applications/myapp/{scripts/{debian,rhel,amazon-linux,common}}
   ```

2. **å»ºç«‹ block.yaml é…ç½®æª”æ¡ˆ**
   ```yaml
   name: "myapp"
   description: "My Application Block"
   version: "1.0.0"
   category: "application"
   
   os_support:
     - os_family: "debian"
       os_versions: ["20.04", "22.04"]
       scripts:
         install: "scripts/debian/install.sh"
         configure: "scripts/debian/configure.sh"
         validate: "scripts/common/validate.sh"
   
   dependencies:
     - "base-ubuntu-2004"
   
   tags:
     - "myapp"
     - "web"
   ```

3. **ç·¨å¯«å®‰è£è…³æœ¬**
   - `scripts/debian/install.sh`: Debian/Ubuntu å®‰è£è…³æœ¬
   - `scripts/rhel/install.sh`: RHEL ç³»åˆ—å®‰è£è…³æœ¬  
   - `scripts/common/configure.sh`: é€šç”¨é…ç½®è…³æœ¬
   - `scripts/common/validate.sh`: é©—è­‰è…³æœ¬

4. **æ›´æ–° builder.pkr.hcl**
   åœ¨ä¸»è¦å»ºæ§‹æª”æ¡ˆä¸­æ–°å¢å°æ‡‰çš„ provisioner

## ğŸ¯ ç©æœ¨é¸æ“‡èˆ‡åˆ†å±¤å¯¦è¸æŒ‡å—

### å®Œæ•´éƒ¨ç½²æ¶æ§‹ç¯„ä¾‹

å‡è¨­æ‚¨è¦ç‚ºå®¢æˆ¶ A å»ºç«‹ä¸€å€‹ Java Web æ‡‰ç”¨ç’°å¢ƒï¼š

```yaml
# ç¬¬1å±¤ - åŸºç¤ç³»çµ±
base-ubuntu-2004              # Ubuntu 20.04 ä½œæ¥­ç³»çµ±

# ç¬¬2å±¤ - é€šç”¨æœå‹™ (é–‹æºè»Ÿé«”)
app-nginx                     # åå‘ä»£ç†
app-postgresql               # é–‹æºè³‡æ–™åº«
app-redis                    # å¿«å–æœå‹™
app-openjdk-11              # Java é‹è¡Œç’°å¢ƒ

# ç¬¬3å±¤ - è‡ªå®šç¾©ç©æœ¨ (å®¢æˆ¶å°ˆæœ‰)
custom-clientA-webapp        # å®¢æˆ¶ A çš„ Java æ‡‰ç”¨ç¨‹å¼
custom-oracle-jdbc-driver    # Oracle å•†æ¥­é©…å‹•ç¨‹å¼
custom-dynatrace-agent       # å•†æ¥­ç›£æ§ä»£ç†

# ç¬¬4å±¤ - Ansible é…ç½® (å¯¦ä¾‹å•Ÿå‹•å¾ŒåŸ·è¡Œ)
ansible-playbook: clientA-production.yml
- è¨­å®šè³‡æ–™åº«é€£ç·šå­—ä¸²
- é…ç½® API ç«¯é»
- æ³¨å…¥æˆæ¬Šé‡‘é‘°
```

### åˆ†å±¤æ±ºç­–æµç¨‹åœ–

```
æ–°è»Ÿé«”éœ€è¦åŠ å…¥ç³»çµ±ï¼Ÿ
    â”‚
    â”œâ”€ æ˜¯é–‹æº/å…è²»è»Ÿé«”å—ï¼Ÿ
    â”‚   â”‚
    â”‚   â”œâ”€ æ˜¯ â†’ æ˜¯å¦é€šç”¨ï¼ˆå¤šå®¢æˆ¶å¯ç”¨ï¼‰ï¼Ÿ
    â”‚   â”‚         â”‚
    â”‚   â”‚         â”œâ”€ æ˜¯ â†’ æ”¾å…¥ç¬¬2å±¤ (app-*)
    â”‚   â”‚         â””â”€ å¦ â†’ æ”¾å…¥ç¬¬3å±¤ (custom-*)
    â”‚   â”‚
    â”‚   â””â”€ å¦ â†’ æ”¾å…¥ç¬¬3å±¤ (custom-*)
    â”‚
    â””â”€ åªæ˜¯é…ç½®ä¿®æ”¹ï¼Ÿ â†’ ä½¿ç”¨ Ansible/cloud-init (ç¬¬4å±¤)
```

### å¯¦éš›ä½¿ç”¨æ¡ˆä¾‹æ¯”è¼ƒ

| éœ€æ±‚ | éŒ¯èª¤åšæ³• âŒ | æ­£ç¢ºåšæ³• âœ… |
|-----|------------|------------|
| å®‰è£ Nginx | æ”¾åœ¨ custom å±¤ | æ”¾åœ¨ app å±¤ (app-nginx) |
| å®‰è£ Oracle Database | æ”¾åœ¨ app å±¤ | æ”¾åœ¨ custom å±¤ (custom-oracle-db) |
| ä¿®æ”¹ Nginx é…ç½® | å¯«å…¥ Packer ç©æœ¨ | ä½¿ç”¨ Ansible é…ç½® |
| å®‰è£å®¢æˆ¶æ‡‰ç”¨ç¨‹å¼ | ä½¿ç”¨ cloud-init | å»ºç«‹ custom ç©æœ¨ |

## ğŸš¨ æ•…éšœæ’é™¤

### å¸¸è¦‹å•é¡Œ

#### 1. SSH é€£ç·šä¸­æ–·
```
Error: Script disconnected unexpectedly
```
**åŸå› ï¼š** Docker æˆ–ç³»çµ±æœå‹™é‡å•Ÿå°è‡´ SSH æ–·ç·š  
**è§£æ±ºæ–¹æ¡ˆï¼š** å·²åœ¨ç›¸é—œ provisioner ä¸­åŠ å…¥ `expect_disconnect = true`

#### 2. æ¢ä»¶åŸ·è¡Œå•é¡Œ
```
Error: Amazon Linux scripts running on Ubuntu
```
**åŸå› ï¼š** Packer æ¢ä»¶åŸ·è¡Œé‚è¼¯éŒ¯èª¤  
**è§£æ±ºæ–¹æ¡ˆï¼š** ä½¿ç”¨ `except` æŒ‡ä»¤å–ä»£ `only` æŒ‡ä»¤

#### 3. æ¨™ç±¤æ ¼å¼éŒ¯èª¤
```
Error: Invalid type for parameter Tags.Value
```
**åŸå› ï¼š** AWS CLI ä¸æ”¯æ´é™£åˆ—æ ¼å¼çš„æ¨™ç±¤å€¼  
**è§£æ±ºæ–¹æ¡ˆï¼š** ä½¿ç”¨æ™ºèƒ½æ¨™ç±¤ç³»çµ±åˆ†é¡è™•ç†

#### 4. debconf å‰ç«¯éŒ¯èª¤
```
debconf: unable to initialize frontend: Dialog
```
**èªªæ˜ï¼š** é€™æ˜¯æ­£å¸¸ç¾è±¡ï¼Œç³»çµ±æœƒè‡ªå‹•é™ç´šåˆ° Teletype æ¨¡å¼ï¼Œä¸å½±éŸ¿å®‰è£

### é™¤éŒ¯æŠ€å·§

1. **å•Ÿç”¨è©³ç´°æ—¥èªŒ**
   ```bash
   export PACKER_LOG=1
   packer build ...
   ```

2. **æª¢æŸ¥ç©æœ¨é…ç½®**
   ```bash
   packer validate -var 'enabled_blocks=["base-ubuntu-2004"]' builder.pkr.hcl
   ```

3. **é©—è­‰ AWS æ¬Šé™**
   ```bash
   aws sts get-caller-identity
   aws ec2 describe-images --owners self
   ```

## ğŸ“ˆ æœ€ä½³å¯¦è¸

### ç©æœ¨é¸æ“‡å»ºè­°

1. **åŸºç¤ç©æœ¨é¸æ“‡**
   - é–‹ç™¼ç’°å¢ƒï¼šUbuntu 20.04ï¼ˆç©©å®šã€è³‡æºè±å¯Œï¼‰
   - ç”Ÿç”¢ç’°å¢ƒï¼šAmazon Linux 2ï¼ˆAWS å„ªåŒ–ï¼‰
   - ä¼æ¥­ç’°å¢ƒï¼šRHEL 8ï¼ˆå•†æ¥­æ”¯æ´ï¼‰

2. **æ‡‰ç”¨ç©æœ¨çµ„åˆ**
   - Web æ‡‰ç”¨ï¼š`app-nginx` + `config-security`
   - å®¹å™¨åŒ–ç’°å¢ƒï¼š`app-docker` + `config-monitoring`
   - é«˜æ•ˆèƒ½ Webï¼š`app-openresty` + `config-security`

3. **é…ç½®ç©æœ¨é¸æ“‡**
   - ç”Ÿç”¢ç’°å¢ƒå¿…å‚™ï¼š`config-security`
   - ç›£æ§éœ€æ±‚ï¼š`config-monitoring` + `config-logging`
   - å‚™ä»½éœ€æ±‚ï¼š`config-backup`

### æ•ˆèƒ½å„ªåŒ–

1. **å¯¦ä¾‹é¡å‹é¸æ“‡**
   - é–‹ç™¼æ¸¬è©¦ï¼š`t3.micro` (1 vCPU, 1GB RAM)
   - å°å‹æ‡‰ç”¨ï¼š`t3.small` (2 vCPU, 2GB RAM)
   - ä¸­å‹æ‡‰ç”¨ï¼š`t3.medium` (2 vCPU, 4GB RAM)

2. **å»ºæ§‹æ™‚é–“å„ªåŒ–**
   - ä½¿ç”¨è¼ƒå¤§çš„å¯¦ä¾‹é¡å‹é€²è¡Œå»ºæ§‹
   - é å…ˆä¸‹è¼‰å¸¸ç”¨å¥—ä»¶åˆ° base ç©æœ¨
   - ä¸¦è¡ŒåŸ·è¡Œç„¡ä¾è³´çš„ç©æœ¨

## ğŸ¤ è²¢ç»æŒ‡å—

1. Fork æ­¤å°ˆæ¡ˆ
2. å»ºç«‹ feature branch (`git checkout -b feature/amazing-block`)
3. æäº¤è®Šæ›´ (`git commit -m 'Add amazing block'`)
4. Push åˆ°åˆ†æ”¯ (`git push origin feature/amazing-block`)
5. å»ºç«‹ Pull Request

### ç©æœ¨è²¢ç»è¦ç¯„

- æ¯å€‹ç©æœ¨å¿…é ˆåŒ…å« `block.yaml` é…ç½®æª”æ¡ˆ
- æ”¯æ´å¤šä½œæ¥­ç³»çµ±çš„ç©æœ¨å¿…é ˆæä¾›å°æ‡‰è…³æœ¬
- æ‰€æœ‰è…³æœ¬å¿…é ˆåŒ…å«éŒ¯èª¤è™•ç† (`set -e`)
- æ–°å¢ç©æœ¨éœ€è¦æ›´æ–°æ–‡ä»¶å’Œç¯„ä¾‹

## ğŸ“œ æˆæ¬Š

æ­¤å°ˆæ¡ˆæ¡ç”¨ MIT æˆæ¬Šæ¢æ¬¾ã€‚è©³è¦‹ `LICENSE` æª”æ¡ˆã€‚

---

**è¯çµ¡è³‡è¨Šï¼š**  
å¦‚æœ‰å•é¡Œæˆ–å»ºè­°ï¼Œè«‹å»ºç«‹ Issue æˆ–è¯ç¹«å°ˆæ¡ˆç¶­è­·è€…ã€‚